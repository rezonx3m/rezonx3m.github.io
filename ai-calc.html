<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Калькулятор уровня команды</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    color: #333;
  }
  
  .container {
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    overflow: hidden;
  }
  
  .header {
    background: #ffffff;
    color: #1e293b;
    padding: 30px 40px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .mobile-warning {
    display: none;
    background: #fef3c7;
    border: 1px solid #fbbf24;
    color: #92400e;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
    text-align: center;
    font-weight: 500;
  }
  
  @media (max-width: 768px) {
    .mobile-warning {
      display: block;
    }
  }
  
  h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .subtitle {
    font-size: 14px;
    color: #64748b;
  }
  
  .content {
    padding: 30px 40px;
  }
  
  .info-container {
    margin-bottom: 24px;
  }

  .info-toggle {
    background: #f8f9fe;
    border: 2px solid #667eea;
    border-radius: 8px;
    padding: 12px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
    user-select: none;
  }

  .info-toggle:hover {
    background: #eef1ff;
  }

  .info-toggle-title {
    font-size: 15px;
    font-weight: 600;
    color: #667eea;
  }

  .info-toggle-icon {
    font-size: 18px;
    color: #667eea;
    transition: transform 0.3s ease;
  }

  .info-toggle-icon.open {
    transform: rotate(180deg);
  }

  .info {
    background: #f8f9fe;
    border: none;
    padding: 0 20px;
    border-radius: 0 0 8px 8px;
    font-size: 14px;
    line-height: 1.6;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease, border 0.3s ease;
  }

  .info.open {
    max-height: 2000px;
    padding: 16px 20px;
    border: 2px solid #667eea;
    border-top: none;
  }
  
  .info b {
    color: #667eea;
    font-weight: 600;
  }
  
  .info ul {
    margin: 12px 0 0 20px;
  }
  
  .info li {
    margin: 6px 0;
  }
  
  .info ul ul {
    margin-top: 6px;
  }
  
  .controls {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .storage-controls {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  
  .storage-btn {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }
  
  .storage-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .storage-btn:active {
    transform: translateY(0);
  }
  
  #fileInput {
    display: none;
  }
  
  .result-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    margin-top: 20px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    text-align: center;
    transition: background 0.5s ease, color 0.5s ease;
  }
  
  .result-box .result-label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
  }
  
  .result-box .result-value {
    font-size: 32px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  
  button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  .table-container {
    display: flex;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    background: white;
  }
  
  .table-left {
    flex-shrink: 0;
    border-right: 2px solid #667eea;
  }
  
  .table-center-wrapper {
    flex-grow: 1;
    overflow-x: auto;
    overflow-y: hidden;
  }
  
  .table-right {
    flex-shrink: 0;
    border-left: 2px solid #667eea;
  }
  
  table {
    border-collapse: collapse;
    background: white;
  }
  
  .table-left table,
  .table-right table {
    width: 100%;
  }
  
  .table-center-wrapper table {
    width: 100%;
    min-width: max-content;
  }
  
  thead {
    background: #667eea;
    color: white;
  }
  
  th {
    padding: 12px 8px;
    text-align: center;
    vertical-align: middle;
    font-weight: 600;
    font-size: 13px;
    border: none;
    white-space: nowrap;
    background: #667eea;
    height: 55px;
    box-sizing: border-box;
  }
  
  .table-left th {
    border-right: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .table-right th {
    border-left: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  tbody tr {
    transition: background-color 0.2s ease;
  }
  
  tbody tr:nth-child(even) {
    background: #f8f9fe;
  }
  
  tbody tr:hover,
  tbody tr.hover-sync {
    background: #f0f2ff;
  }
  
  td {
    padding: 10px 8px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #e5e7eb;
    font-size: 13px;
    height: 93px;
    box-sizing: border-box;
  }
  
  .table-left td {
    border-right: none;
  }
  
  .table-center-wrapper td {
    border-left: none;
    border-right: none;
  }
  
  .table-right td {
    border-left: none;
    font-weight: 600;
  }
  
  .col-process {
    width: 180px;
    min-width: 180px;
    white-space: nowrap;
  }
  
  .col-weight {
    width: 70px;
    min-width: 70px;
  }
  
  .col-auto {
    width: 120px;
    min-width: 120px;
  }
  
  .col-result {
    width: 100px;
    min-width: 100px;
  }
  
  input[type="text"] {
    width: 100%;
    max-width: 120px;
    padding: 5px 8px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 12px;
    transition: all 0.2s ease;
  }
  
  input[type="text"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  input[type="number"] {
    width: 50px;
    padding: 6px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
    transition: all 0.2s ease;
  }
  
  input[type="number"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  input[type="number"].empty-weight,
  input[type="text"].empty-name {
    border-color: #fca5a5;
    background-color: #fef2f2;
  }
  
  input[type="number"].empty-weight:focus,
  input[type="text"].empty-name:focus {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }
  
  input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #667eea;
  }
  
  .delete-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    margin-left: 4px;
    transition: all 0.2s ease;
    box-shadow: none;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    width: 20px;
    height: 20px;
  }
  
  .delete-btn:hover {
    background: #dc2626;
    transform: scale(1.05);
  }
  
  .slider-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 4px;
  }
  
  .slider-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .slider-input {
    width: 55px;
    padding: 5px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .slider-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  input[type="range"] {
    width: 90px;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: #e5e7eb;
    border-radius: 3px;
    outline: none;
    cursor: pointer;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
  }
  
  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
  }
  
  input[type="range"]::-moz-range-thumb:hover {
    transform: scale(1.2);
  }
  
  .none-btn {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: none;
    min-width: 32px;
  }
  
  .none-btn:hover {
    background: #667eea;
    color: white;
    transform: scale(1.05);
  }
  
  .add-employee-header {
    background: #667eea;
    color: white;
    padding: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    vertical-align: middle;
    min-width: 140px;
  }
  
  .add-employee-header:hover {
    background: #5568d3;
  }
  
  .add-process-row td {
    background: #f8f9fe;
    padding: 12px;
    transition: all 0.3s ease;
    height: 40px;
  }
  
  .add-process-btn {
    color: #667eea;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
  }
  
  .table-left .add-process-row:hover td {
    background: #eef1ff;
  }
  
  .add-employee-column-cell {
    background: transparent !important;
  }
  
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .header, .content {
      padding: 20px;
    }
    
    h1 {
      font-size: 22px;
    }
    
    .info {
      font-size: 13px;
      padding: 12px 16px;
    }
    
    th, td {
      padding: 8px 6px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="mobile-warning">
      ⚠️ Данный калькулятор не адаптирован под мобильную версию. Пожалуйста, используйте широкие экраны для корректного отображения.
    </div>
    <h1>Калькулятор уровня зрелости команды</h1>
    <div class="subtitle">Оцените компетенции вашей команды по ключевым процессам</div>
  </div>
  
  <div class="content">
    <div class="storage-controls">
      <button class="storage-btn" onclick="exportData()">📤 Выгрузить данные</button>
      <button class="storage-btn" onclick="document.getElementById('fileInput').click()">📥 Загрузить данные</button>
      <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
    </div>
    
    <div class="info-container">
      <div class="info-toggle" onclick="toggleInfo('info1')">
        <span class="info-toggle-title">📖 Инструкция по использованию</span>
        <span class="info-toggle-icon" id="icon1">▼</span>
      </div>
      <div class="info" id="info1">
        <p><b>Как пользоваться калькулятором:</b></p>
        <ul>
          <li>Добавляйте <b>процессы</b> (например, «Кодинг», «Тестирование») и <b>сотрудников</b> с помощью кнопок.</li>
          <li>Для каждого процесса укажите его <b>вес</b> (важность) от 1 до 5.</li>
          <li>Для каждого сотрудника выберите уровень участия с помощью <b>ползунка</b>:
            <ul>
              <li><b>–</b> — не участвует</li>
              <li><b>0</b> — минимальный уровень</li>
              <li><b>1</b> — базовый уровень</li>
              <li><b>2</b> — высокий уровень</li>
            </ul>
            Можно также ввести значение вручную (например, 1.5).
          </li>
          <li>Если процесс <b>автоматизирован</b>, поставьте галочку — тогда уровень считается максимальным (2), а вклад сотрудников не учитывается.</li>
          <li>Внизу отображается <b>общий уровень команды</b>.</li>
          <li><b>💾 Сохранение данных:</b> Все данные хранятся локально в браузере (localStorage). Однако, чтобы не потерять информацию при очистке кэша или переустановке браузера, рекомендуется периодически выгружать данные в JSON-файл с помощью кнопки "Выгрузить данные".</li>
        </ul>
        
        <p style="margin-top: 16px;"><b>Что означает «Процесс автоматизирован»?</b></p>
        <p>
          Это означает, что выполнение задачи не зависит напрямую от уровня конкретного сотрудника.  
          Например, при ревью кода агент (например, <i>pr-agent</i>) может автоматически анализировать PR и выдавать замечания.  
          Тогда процесс считается <b>автоматизированным</b>, хотя команда всё равно может делать дополнительное ревью вручную.
        </p>
        
        <p style="margin-top: 16px;"><b>Почему общий уровень команды — это не «среднее по больнице»?</b></p>
        <p>
          Общий уровень команды рассчитывается как <b>взвешенное среднее</b>, где вес процесса отражает его критичность для достижения целей проекта.  
          При правильной расстановке весов итоговое значение становится <b>практическим ориентиром</b>:
        </p>
        <ul>
          <li>Если для вашего проекта критичны код-ревью и тестирование, им стоит назначить высокий вес (4–5).</li>
          <li>Менее важные процессы (например, документирование в MVP-проектах) могут иметь низкий вес (1–2).</li>
          <li>Итоговый показатель отражает <b>реальную готовность команды</b> работать эффективно в контексте ваших приоритетов, а не усреднённую оценку всех процессов.</li>
        </ul>
        <p>
          Таким образом, команда может <b>опираться на этот показатель</b> для принятия решений: 
          какие процессы требуют усиления, где нужно больше автоматизации или обучения, и насколько команда готова к текущим вызовам.
        </p>
      </div>
    </div>


    <div class="table-container">
      <div class="table-left">
        <table id="leftTable">
          <thead>
            <tr>
              <th class="col-process">Процесс</th>
              <th class="col-weight">Вес<br>(1–5)</th>
              <th class="col-auto" title="Процесс не зависит от конкретного уровня сотрудников">Процесс<br>автоматизир.</th>
            </tr>
          </thead>
          <tbody id="leftBody"></tbody>
        </table>
      </div>
      
      <div class="table-center-wrapper" id="centerWrapper">
        <table id="centerTable">
          <thead>
            <tr id="centerHeader">
              <!-- Сотрудники добавляются сюда -->
            </tr>
          </thead>
          <tbody id="centerBody"></tbody>
        </table>
      </div>
      
      <div class="table-right">
        <table id="rightTable">
          <thead>
            <tr>
              <th class="col-result">Уровень<br>процесса</th>
            </tr>
          </thead>
          <tbody id="rightBody"></tbody>
        </table>
      </div>
    </div>
    
    <div class="result-box">
      <div class="result-label">Общий уровень зрелости команды</div>
      <div class="result-value" id="overallResult">0.00</div>
    </div>
  </div>
</div>

<script>
const levels = { "0": 0, "1": 1, "2": 2, "-": null };
const defaultProcesses = ["Генерация идей, ТЗ", "Кодинг", "Ревью (PR/MR)", "Тестирование", "Документирование"];
const defaultEmployees = ["Иванов", "Петров", "Сидоров", "Смирнов", "Кузнецов", "Попов"];

let rowIndex = 0; // Счётчик для синхронизации строк

// ===== Утилиты для localStorage =====
function setLocalStorage(name, value) {
  try {
    localStorage.setItem(name, JSON.stringify(value));
  } catch (e) {
    console.error('Ошибка сохранения в localStorage:', e);
  }
}
function getLocalStorage(name) {
  try {
    const item = localStorage.getItem(name);
    return item ? JSON.parse(item) : null;
  } catch (e) {
    console.error('Ошибка загрузки из localStorage:', e);
    return null;
  }
}

// ===== Синхронизация hover эффектов между таблицами =====
function syncHoverEffects() {
  const leftRows = document.querySelectorAll("#leftBody tr");
  const centerRows = document.querySelectorAll("#centerBody tr");
  const rightRows = document.querySelectorAll("#rightBody tr");

  [leftRows, centerRows, rightRows].forEach(rows => {
    rows.forEach((row, index) => {
      row.addEventListener("mouseenter", () => {
        leftRows[index]?.classList.add("hover-sync");
        centerRows[index]?.classList.add("hover-sync");
        rightRows[index]?.classList.add("hover-sync");
      });
      row.addEventListener("mouseleave", () => {
        leftRows[index]?.classList.remove("hover-sync");
        centerRows[index]?.classList.remove("hover-sync");
        rightRows[index]?.classList.remove("hover-sync");
      });
    });
  });
}

// ===== Элемент уровня сотрудника =====
function createLevelCell(auto = false, initialValue = "-") {
  const cell = document.createElement("td");
  const container = document.createElement("div");
  container.className = "slider-container";

  const sliderRow = document.createElement("div");
  sliderRow.className = "slider-row";

  const noneBtn = document.createElement("button");
  noneBtn.textContent = "–";
  noneBtn.className = "none-btn";

  const range = document.createElement("input");
  range.type = "range";
  range.min = 0;
  range.max = 2;
  range.step = 0.1;
  range.value = initialValue === "-" ? 0 : initialValue;
  range.disabled = auto;

  const numberInput = document.createElement("input");
  numberInput.type = "number";
  numberInput.min = 0;
  numberInput.max = 2;
  numberInput.step = 0.1;
  numberInput.className = "slider-input";
  numberInput.value = initialValue === "-" ? "" : initialValue;

  // Устанавливаем начальную подсветку кнопки "–"
  if (initialValue === "-") {
    noneBtn.style.background = "#eee";
  }

  function updateFromRange() {
    numberInput.value = range.value;
    noneBtn.style.background = "";
    calculate(); saveTableToStorage();
  }

  function updateFromNumber() {
    // Если поле пустое, устанавливаем "–"
    if (numberInput.value === "" || numberInput.value.trim() === "") {
      setNone();
      return;
    }
    
    let val = parseFloat(numberInput.value);
    if (!isNaN(val)) {
      // Ограничиваем значение диапазоном от 0 до 2
      if (val < 0) val = 0;
      if (val > 2) val = 2;
      numberInput.value = val;
      range.value = val;
      noneBtn.style.background = "";
      calculate(); saveTableToStorage();
    }
  }

  function setNone() {
    numberInput.value = "";
    range.value = 0;
    noneBtn.style.background = "#eee";
    calculate(); saveTableToStorage();
  }

  range.addEventListener("input", updateFromRange);
  numberInput.addEventListener("input", updateFromNumber);
  noneBtn.addEventListener("click", setNone);

  sliderRow.append(noneBtn, range);
  container.append(numberInput, sliderRow);
  cell.appendChild(container);
  return cell;
}

// ===== Валидация веса =====
function validateWeightInput(input) {
  if (!input.value || input.value === "" || parseFloat(input.value) < 1) {
    input.classList.add("empty-weight");
  } else {
    input.classList.remove("empty-weight");
  }
}

// ===== Валидация имени =====
function validateNameInput(input) {
  if (!input.value || input.value.trim() === "") {
    input.classList.add("empty-name");
  } else {
    input.classList.remove("empty-name");
  }
}

// ===== Обновление строки добавления процесса =====
function updateAddProcessRow() {
  const centerHeader = document.getElementById("centerHeader");
  const employeeCount = centerHeader.querySelectorAll("th:not(.add-employee-header)").length;
  
  // Левая таблица
  let leftAddRow = document.querySelector("#leftBody tr.add-process-row");
  if (!leftAddRow) {
    leftAddRow = document.createElement("tr");
    leftAddRow.className = "add-process-row";
    
    const cell = document.createElement("td");
    cell.className = "add-process-btn";
    cell.colSpan = 3;
    cell.textContent = "+ Добавить";
    cell.onclick = () => addProcess();
    
    leftAddRow.appendChild(cell);
    document.getElementById("leftBody").appendChild(leftAddRow);
  }
  
  // Центральная таблица
  let centerAddRow = document.querySelector("#centerBody tr.add-process-row");
  const hasAddButton = document.querySelector('#centerHeader .add-employee-header');
  
  if (!centerAddRow) {
    centerAddRow = document.createElement("tr");
    centerAddRow.className = "add-process-row";
    
    const cell = document.createElement("td");
    cell.className = "add-process-btn";
    cell.textContent = "";
    cell.style.background = "transparent";
    cell.style.cursor = "default";
    centerAddRow.appendChild(cell);
    
    // Добавляем пустую ячейку для колонки "Добавить", если кнопка есть
    if (hasAddButton) {
      const emptyCell = document.createElement("td");
      emptyCell.className = "add-employee-column-cell";
      centerAddRow.appendChild(emptyCell);
    }
    
    document.getElementById("centerBody").appendChild(centerAddRow);
  }
  
  // Обновляем colspan в центральной таблице
  const centerCell = centerAddRow.children[0];
  centerCell.colSpan = Math.max(1, employeeCount);
  
  // Обновляем количество пустых ячеек
  const currentEmptyCells = centerAddRow.querySelectorAll('td:not(.add-process-btn)').length;
  if (hasAddButton && currentEmptyCells === 0) {
    const emptyCell = document.createElement("td");
    emptyCell.className = "add-employee-column-cell";
    centerAddRow.appendChild(emptyCell);
  } else if (!hasAddButton && currentEmptyCells > 0) {
    centerAddRow.querySelectorAll('td:not(.add-process-btn)').forEach(cell => cell.remove());
  }
  
  // Правая таблица
  let rightAddRow = document.querySelector("#rightBody tr.add-process-row");
  if (!rightAddRow) {
    rightAddRow = document.createElement("tr");
    rightAddRow.className = "add-process-row";
    
    const cell = document.createElement("td");
    cell.style.background = "transparent";
    cell.textContent = "";
    
    rightAddRow.appendChild(cell);
    document.getElementById("rightBody").appendChild(rightAddRow);
  }
}

// ===== Инициализация кнопки добавления сотрудника =====
function initAddEmployeeButton() {
  const centerHeader = document.getElementById("centerHeader");
  
  // Убираем старую кнопку, если есть
  const oldBtn = centerHeader.querySelector('.add-employee-header');
  if (oldBtn) {
    oldBtn.remove();
  }
  
  // Добавляем кнопку
  const addEmployeeHeader = document.createElement("th");
  addEmployeeHeader.className = "add-employee-header";
  addEmployeeHeader.textContent = "+ Добавить";
  addEmployeeHeader.onclick = () => addEmployee();
  centerHeader.appendChild(addEmployeeHeader);
  
  // Добавляем пустые ячейки для колонки "Добавить" во все существующие строки, если их еще нет
  const employeeCount = centerHeader.querySelectorAll("th:not(.add-employee-header)").length;
  document.querySelectorAll("#centerBody tr:not(.add-process-row)").forEach(row => {
    // Проверяем, нужно ли добавить пустую ячейку (если ячеек меньше, чем сотрудников + 1)
    if (row.children.length === employeeCount) {
      const emptyCell = document.createElement("td");
      emptyCell.className = "add-employee-column-cell";
      row.appendChild(emptyCell);
    }
  });
}

// ===== Добавление процессов и сотрудников =====
function addProcess(name = "") {
  const currentIndex = rowIndex++;
  
  // Убираем строки добавления процесса, если они есть
  document.querySelectorAll("tr.add-process-row").forEach(row => row.remove());
  
  // Левая таблица (Процесс, Вес, Автоматизация)
  const leftRow = document.createElement("tr");
  leftRow.dataset.rowIndex = currentIndex;

  // Процесс
  const processCell = document.createElement("td");
  processCell.className = "col-process";
  const processInput = document.createElement("input");
  processInput.type = "text";
  processInput.value = name;
  
  // Сохраняем при изменении названия процесса
  processInput.addEventListener("input", () => {
    validateNameInput(processInput);
    saveTableToStorage();
  });
  processInput.addEventListener("blur", () => {
    validateNameInput(processInput);
  });
  
  processCell.appendChild(processInput);

  const delBtn = document.createElement("button");
  delBtn.textContent = "✖";
  delBtn.className = "delete-btn";
  delBtn.onclick = () => { removeProcess(currentIndex); };
  processCell.appendChild(delBtn);
  leftRow.appendChild(processCell);

  // Вес
  const weightCell = document.createElement("td");
  weightCell.className = "col-weight";
  const weightInput = document.createElement("input");
  weightInput.type = "number";
  weightInput.min = 1;
  weightInput.max = 5;
  weightInput.value = 1;
  weightInput.addEventListener("input", () => { 
    validateWeightInput(weightInput);
    calculate(); 
    saveTableToStorage();
  });
  weightInput.addEventListener("blur", () => {
    validateWeightInput(weightInput);
  });
  weightCell.appendChild(weightInput);
  leftRow.appendChild(weightCell);

  // Автоматизация
  const autoCell = document.createElement("td");
  autoCell.className = "col-auto";
  const autoCheckbox = document.createElement("input");
  autoCheckbox.type = "checkbox";
  autoCheckbox.addEventListener("change", () => {
    const centerRow = document.querySelector(`#centerBody tr[data-row-index="${currentIndex}"]`);
    if (centerRow) {
      centerRow.querySelectorAll("input").forEach(inp => inp.disabled = autoCheckbox.checked);
    }
    calculate(); saveTableToStorage();
  });
  autoCell.appendChild(autoCheckbox);
  leftRow.appendChild(autoCell);

  document.getElementById("leftBody").appendChild(leftRow);

  // Центральная таблица (Сотрудники)
  const centerRow = document.createElement("tr");
  centerRow.dataset.rowIndex = currentIndex;
  const centerHeader = document.getElementById("centerHeader");
  const employeeCount = centerHeader.querySelectorAll("th:not(.add-employee-header)").length;
  for (let i = 0; i < employeeCount; i++) {
    const cell = createLevelCell(autoCheckbox.checked, "-");
    centerRow.appendChild(cell);
  }
  
  // Добавляем пустую ячейку для колонки "Добавить"
  if (centerHeader.querySelector('.add-employee-header')) {
    const emptyCell = document.createElement("td");
    emptyCell.className = "add-employee-column-cell";
    centerRow.appendChild(emptyCell);
  }
  
  document.getElementById("centerBody").appendChild(centerRow);

  // Правая таблица (Итог)
  const rightRow = document.createElement("tr");
  rightRow.dataset.rowIndex = currentIndex;
  const resultCell = document.createElement("td");
  resultCell.className = "col-result";
  resultCell.textContent = "0";
  rightRow.appendChild(resultCell);
  document.getElementById("rightBody").appendChild(rightRow);

  // Добавляем строку с кнопкой добавления процесса
  updateAddProcessRow();

  syncHoverEffects();
  calculate();
  saveTableToStorage();
}

function removeProcess(index) {
  document.querySelector(`#leftBody tr[data-row-index="${index}"]`)?.remove();
  document.querySelector(`#centerBody tr[data-row-index="${index}"]`)?.remove();
  document.querySelector(`#rightBody tr[data-row-index="${index}"]`)?.remove();
  syncHoverEffects();
  calculate();
  saveTableToStorage();
}

function addEmployee(name = "") {
  const centerHeader = document.getElementById("centerHeader");
  
  // Убираем кнопку добавления, если она есть
  const addBtn = centerHeader.querySelector('.add-employee-header');
  if (addBtn) {
    addBtn.remove();
  }
  
  const th = document.createElement("th");
  const input = document.createElement("input");
  input.type = "text";
  input.value = name;
  input.placeholder = "ФИО";
  
  // Сохраняем при изменении ФИО
  input.addEventListener("input", () => {
    validateNameInput(input);
    saveTableToStorage();
  });
  input.addEventListener("blur", () => {
    validateNameInput(input);
  });

  const delBtn = document.createElement("button");
  delBtn.textContent = "✖";
  delBtn.className = "delete-btn";
  delBtn.onclick = () => { removeEmployee(th.cellIndex); };

  th.append(input, delBtn);
  centerHeader.appendChild(th);

  // Добавляем ячейку для каждого процесса ПЕРЕД последней пустой ячейкой
  document.querySelectorAll("#centerBody tr:not(.add-process-row)").forEach((row, idx) => {
    const leftRow = document.querySelectorAll("#leftBody tr:not(.add-process-row)")[idx];
    const auto = leftRow ? leftRow.children[2].firstChild.checked : false;
    const cell = createLevelCell(auto, "-");
    
    // Находим последнюю ячейку (пустую для кнопки "Добавить")
    const lastCell = row.querySelector('.add-employee-column-cell');
    if (lastCell) {
      // Вставляем новую ячейку перед пустой
      row.insertBefore(cell, lastCell);
    } else {
      // Если пустой ячейки нет, добавляем в конец
      row.appendChild(cell);
    }
  });
  
  // Добавляем кнопку добавления сотрудника в конец
  const addEmployeeHeader = document.createElement("th");
  addEmployeeHeader.className = "add-employee-header";
  addEmployeeHeader.textContent = "+ Добавить";
  addEmployeeHeader.onclick = () => addEmployee();
  centerHeader.appendChild(addEmployeeHeader);
  
  // Добавляем пустые ячейки для колонки "Добавить" во все строки, если их еще нет
  document.querySelectorAll("#centerBody tr:not(.add-process-row)").forEach(row => {
    if (!row.querySelector('.add-employee-column-cell')) {
      const emptyCell = document.createElement("td");
      emptyCell.className = "add-employee-column-cell";
      row.appendChild(emptyCell);
    }
  });
  
  // Обновляем colspan в строке добавления процесса
  updateAddProcessRow();

  saveTableToStorage();
  calculate();
}

function removeEmployee(index) {
  const centerHeader = document.getElementById("centerHeader");
  centerHeader.removeChild(centerHeader.children[index]);
  document.querySelectorAll("#centerBody tr:not(.add-process-row)").forEach(row => {
    row.removeChild(row.children[index]);
  });
  
  // Обновляем colspan в строке добавления процесса
  updateAddProcessRow();
  
  calculate();
  saveTableToStorage();
}

// ===== Функция для получения цвета фона в зависимости от уровня =====
function getBackgroundForLevel(level) {
  const value = parseFloat(level);
  
  if (value >= 2) {
    // 2 и выше - зеленый цвет
    return '#10b981';
  } else if (value >= 1) {
    // От 1 до 2: плавный переход от желтого к зеленому
    const ratio = value - 1; // 0..1
    const r = Math.round(255 - (255 - 16) * ratio);    // от 255 (желтый) до 16 (зеленый)
    const g = Math.round(217 - (217 - 185) * ratio);   // от 217 (желтый) до 185 (зеленый)
    const b = Math.round(61 + (129 - 61) * ratio);     // от 61 (желтый) до 129 (зеленый)
    return `rgb(${r}, ${g}, ${b})`;
  } else {
    // От 0 до 1: плавный переход от красного к желтому
    const ratio = value; // 0..1
    const r = Math.round(255 - (255 - 255) * ratio);   // от 255 (красный) до 255 (желтый)
    const g = Math.round(107 + (217 - 107) * ratio);   // от 107 (красный) до 217 (желтый)
    const b = Math.round(107 - (107 - 61) * ratio);    // от 107 (красный) до 61 (желтый)
    return `rgb(${r}, ${g}, ${b})`;
  }
}

// ===== Расчёт =====
function calculate() {
  const leftRows = document.querySelectorAll("#leftBody tr:not(.add-process-row)");
  const centerRows = document.querySelectorAll("#centerBody tr:not(.add-process-row)");
  const rightRows = document.querySelectorAll("#rightBody tr:not(.add-process-row)");
  
  let totalWeighted = 0, totalWeight = 0;

  leftRows.forEach((leftRow, idx) => {
    const weightInput = leftRow.children[1].firstChild;
    const weight = parseFloat(weightInput.value) || 1;
    validateWeightInput(weightInput);
    const auto = leftRow.children[2].firstChild.checked;
    let processLevel = 0;

    if (auto) {
      processLevel = 2;
    } else {
      const centerRow = centerRows[idx];
      if (centerRow) {
        let sum = 0, count = 0;
        centerRow.querySelectorAll('input[type="number"]').forEach(numberInput => {
          if (numberInput.value !== "") {
            const val = parseFloat(numberInput.value);
            if (!isNaN(val)) { sum += val; count++; }
          }
        });
        processLevel = count > 0 ? sum / count : 0;
      }
    }
    
    if (rightRows[idx]) {
      rightRows[idx].firstChild.textContent = processLevel.toFixed(2);
    }
    
    totalWeighted += processLevel * weight;
    totalWeight += weight;
  });

  const overall = totalWeight > 0 ? (totalWeighted / totalWeight).toFixed(2) : "0.00";
  document.getElementById("overallResult").textContent = overall;
  
  // Обновляем фон в зависимости от уровня
  const resultBox = document.querySelector(".result-box");
  resultBox.style.background = getBackgroundForLevel(overall);
  
  // Изменяем цвет текста в зависимости от яркости фона
  const value = parseFloat(overall);
  if (value < 1.5) {
    // Для красного и желтого фона используем темный текст
    resultBox.style.color = "#1e293b";
  } else {
    // Для зеленого и радужного используем белый текст
    resultBox.style.color = "white";
  }
}

// ===== Сохранение и загрузка =====
function saveTableToStorage() {
  const processes = [];
  const leftRows = document.querySelectorAll("#leftBody tr:not(.add-process-row)");
  const centerRows = document.querySelectorAll("#centerBody tr:not(.add-process-row)");

  leftRows.forEach((leftRow, idx) => {
    const p = {
      name: leftRow.children[0].firstChild.value,
      weight: leftRow.children[1].firstChild.value,
      auto: leftRow.children[2].firstChild.checked,
      levels: []
    };
    
    const centerRow = centerRows[idx];
    if (centerRow) {
      centerRow.querySelectorAll('input[type="number"]').forEach(numberInput => {
        const valText = numberInput.value !== "" ? numberInput.value : "–";
        p.levels.push(valText);
      });
    }
    
    processes.push(p);
  });

  const employees = [];
  const centerHeader = document.getElementById("centerHeader");
  centerHeader.querySelectorAll("th:not(.add-employee-header)").forEach(th => {
    employees.push(th.firstChild.value);
  });

  setLocalStorage('processes', processes);
  setLocalStorage('employees', employees);
}

function loadTableFromStorage() {
  const savedEmployees = getLocalStorage('employees');
  const savedProcesses = getLocalStorage('processes');

  // Используем дефолтные значения только если нет сохранённых данных
  const hasData = savedEmployees || savedProcesses;

  // Загружаем сотрудников
  if (savedEmployees && savedEmployees.length > 0) {
    savedEmployees.forEach(name => addEmployee(name));
  } else if (!hasData) {
    defaultEmployees.forEach(name => addEmployee(name));
  } else {
    // Если нет сохраненных сотрудников, но есть процессы, просто добавляем кнопку
    initAddEmployeeButton();
  }

  // Загружаем процессы
  if (savedProcesses && savedProcesses.length > 0) {
    document.getElementById("leftBody").innerHTML = '';
    document.getElementById("centerBody").innerHTML = '';
    document.getElementById("rightBody").innerHTML = '';
    rowIndex = 0;
    
    savedProcesses.forEach(p => {
      addProcess(p.name);
      
      const leftRows = document.querySelectorAll("#leftBody tr:not(.add-process-row)");
      const centerRows = document.querySelectorAll("#centerBody tr:not(.add-process-row)");
      const lastLeftRow = leftRows[leftRows.length - 1];
      const lastCenterRow = centerRows[centerRows.length - 1];
      
      if (lastLeftRow) {
        const processInput = lastLeftRow.children[0].firstChild;
        validateNameInput(processInput);
        const weightInput = lastLeftRow.children[1].firstChild;
        weightInput.value = p.weight;
        validateWeightInput(weightInput);
        lastLeftRow.children[2].firstChild.checked = p.auto;
      }
      
      if (lastCenterRow) {
        const cells = lastCenterRow.querySelectorAll("td");
        for (let i = 0; i < p.levels.length && i < cells.length; i++) {
          const cell = cells[i];
          const val = p.levels[i];
          const range = cell.querySelector('input[type="range"]');
          const number = cell.querySelector('input[type="number"]');
          const noneBtn = cell.querySelector('.none-btn');
          
          if (val === "–") {
            number.value = "";
            range.value = 0;
            if (noneBtn) noneBtn.style.background = "#eee";
          } else {
            range.value = val;
            number.value = val;
            if (noneBtn) noneBtn.style.background = "";
          }
          cell.querySelectorAll("input").forEach(inp => inp.disabled = p.auto);
        }
      }
    });
  } else if (!hasData) {
    defaultProcesses.forEach(name => addProcess(name));
  }

  // Валидируем все имена сотрудников после загрузки
  document.querySelectorAll("#centerHeader input[type='text']").forEach(input => {
    validateNameInput(input);
  });

  // Инициализируем кнопку добавления сотрудника, если ее еще нет
  if (!document.querySelector('.add-employee-header')) {
    initAddEmployeeButton();
  }
  
  // Инициализируем строку добавления процесса, если ее еще нет
  if (!document.querySelector('.add-process-row')) {
    updateAddProcessRow();
  }

  calculate();
}

// ===== Переключение информационного блока =====
function toggleInfo(id) {
  const infoBlock = document.getElementById(id);
  const icon = document.getElementById('icon1');
  
  if (infoBlock.classList.contains('open')) {
    infoBlock.classList.remove('open');
    icon.classList.remove('open');
  } else {
    infoBlock.classList.add('open');
    icon.classList.add('open');
  }
}

// ===== Экспорт и импорт данных =====
function exportData() {
  const employees = getLocalStorage('employees') || [];
  const processes = getLocalStorage('processes') || [];
  
  const data = {
    version: "1.0",
    exportDate: new Date().toISOString(),
    employees: employees,
    processes: processes
  };
  
  // Создаем blob с JSON данными
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  // Создаем ссылку для скачивания
  const a = document.createElement('a');
  a.href = url;
  a.download = `team-maturity-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  
  // Очищаем
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert('✅ Данные успешно выгружены!');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      // Проверяем структуру данных
      if (!data.employees || !data.processes) {
        throw new Error('Неверный формат файла');
      }
      
      // Сохраняем данные в localStorage
      setLocalStorage('employees', data.employees);
      setLocalStorage('processes', data.processes);
      
      // Очищаем таблицы
      document.getElementById("leftBody").innerHTML = '';
      document.getElementById("centerBody").innerHTML = '';
      document.getElementById("rightBody").innerHTML = '';
      document.getElementById("centerHeader").innerHTML = '';
      rowIndex = 0;
      
      // Перезагружаем таблицу
      loadTableFromStorage();
      
      alert('✅ Данные успешно загружены!');
    } catch (error) {
      console.error('Ошибка импорта:', error);
      alert('❌ Ошибка при загрузке файла. Убедитесь, что файл имеет правильный формат.');
    }
  };
  
  reader.onerror = function() {
    alert('❌ Ошибка при чтении файла.');
  };
  
  reader.readAsText(file);
  
  // Сбрасываем значение input, чтобы можно было загрузить тот же файл повторно
  event.target.value = '';
}

// ===== Инициализация =====
loadTableFromStorage();
</script>

</body>
</html>
